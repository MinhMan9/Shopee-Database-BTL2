{% extends "base.html" %}
{% block title %}Dashboard Kh√°ch H√†ng{% endblock %}

{% block content %}
    <style>
        /* CSS cho h·ªá th·ªëng Tab */
        .tab-menu { list-style: none; padding: 0; margin: 0 0 20px 0; border-bottom: 2px solid #ddd; display: flex; }
        .tab-menu li { padding: 10px 20px; cursor: pointer; border: 1px solid transparent; border-bottom: none; margin-right: 5px; font-weight: 500; color: #777; }
        .tab-menu li.active { border-color: #ddd #ddd #fff; color: #ee4d2d; font-weight: bold; }
    </style>

    <!-- ... MISSING CODE (lines 10-46) ... -->

            <div style="margin-top: 15px; padding: 15px; border: 1px solid #4a90e2; border-radius: 5px; background-color: #eaf3ff;">
                <h4>üèÜ Ki·ªÉm tra ThƒÉng h·∫°ng (Function)</h4>
                {% if tier_info %}
                {% if tier_info.SpendingNeeded > 0 %}
                    <p>C·∫ßn chi ti√™u th√™m <strong>{{ tier_info.SpendingNeeded | format_currency }}</strong> ƒë·ªÉ ƒë·∫°t c·∫•p <strong>{{ tier_info.NextTierName }}</strong>.</p>
                {% else %}
                    <p>Ch√∫c m·ª´ng! B·∫°n ƒëang ·ªü c·∫•p cao nh·∫•t ({{ tier_info.CurrentTierName }}) ho·∫∑c ƒë√£ ƒë·∫°t y√™u c·∫ßu thƒÉng h·∫°ng.</p>
                {% endif %}
                {% else %}
                    <p>Kh√¥ng th·ªÉ ki·ªÉm tra th√¥ng tin thƒÉng h·∫°ng.</p>
                {% endif %}

            </div>

            {% else %}
                <!-- ... MISSING CODE ... -->
            {% endif %}

        <div id="shopping-cart" class="tab-pane">
            <h3>C√°c S·∫£n ph·∫©m hi·ªán c√≥ trong Gi·ªè h√†ng</h3>
            <p style="font-size: 1.1em; font-weight: bold; color: #ee4d2d;">T·ªîNG GI√Å TR·ªä GI·ªé H√ÄNG {{ cart_total | format_currency }}</p>

            {% if cart_items %}
            <table class="data-table" style="width: 100%; margin-bottom: 30px;">
                <!-- ... MISSING CODE ... -->
            </table>
            {% endif %}

            <h4>Voucher c√≥ th·ªÉ √°p d·ª•ng</h4>
            <div style="padding: 15px; border: 1px solid #c3e6cb; background-color: #f0fff0;">
                {% set applicable_vouchers = vouchers_with_status | selectattr('is_valid_for_cart') | list %}
                {% if applicable_vouchers %}
                    <p style="color: green;">T√¨m th·∫•y <strong>{{ applicable_vouchers | length }}</strong> voucher c√≥ th·ªÉ s·ª≠ d·ª•ng:</p>
                    <ul>
                        {% for voucher in applicable_vouchers %}
                            <li style="font-weight: bold;">[ID: {{ voucher.voucher_id }}] {{ voucher.description }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>

        <div id="products" class="tab-pane">
            <h3>üõí T√¨m ki·∫øm & Th·ªëng k√™ S·∫£n ph·∫©m Chi ti·∫øt</h3>
            
            <form method="GET" action="{{ url_for('customer_dashboard') }}">
                <input type="hidden" name="tab" value="products">

                <label for="ten_dm">T√™n Danh m·ª•c:</label>
                <input type="text" id="ten_dm" name="ten_dm" value="{{ request.args.get('ten_dm') or '' }}" style="margin-right: 15px;">

                <label for="min_sales">Doanh s·ªë Min:</label>
                <input type="number" id="min_sales" name="min_sales" value="{{ request.args.get('min_sales') or '' }}" style="margin-right: 15px;">

                <label for="min_rating">Rating Min:</label>
                <input type="number" id="min_rating" name="min_rating" step="0.1" value="{{ request.args.get('min_rating') or '' }}" style="margin-right: 15px;">

                <button type="submit" style="background-color: #ee4d2d;">T√¨m ki·∫øm/L·ªçc</button>
            </form>

            <h4 style="margin-top: 20px;">K·∫øt qu·∫£: {{ search_results | length }} s·∫£n ph·∫©m</h4>
            
            {% if search_results %}
                <table class="data-table" style="width: 100%;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√™n S·∫£n Ph·∫©m</th>
                            <th>Danh M·ª•c</th>
                            <th>Shop</th>
                            <th>{{ sort_header_link('CurrentPrice', 'Gi√° HT', current_sort_by, current_order) }}</th>
                            <th>{{ sort_header_link('TotalUnitsSold', 'T·ªïng B√°n', current_sort_by, current_order) }}</th>
                            <th>T·ªïng Doanh Thu</th>
                            <th>{{ sort_header_link('AvgRating', 'Rating TB', current_sort_by, current_order) }}</th>
                            <th>Total Reviews</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- ... MISSING CODE ... -->
                    </tbody>
                </table>
            {% endif %}
        </div>

    <script>
        // ... MISSING CODE ...
    </script>
{% endblock %}

{% macro sort_header_link(column_name, display_name, current_sort, current_order) %}
    {% set new_order = 'asc' if current_sort == column_name and current_order == 'desc' else 'desc' %}

    {% set query_params = {
        'tab': 'products',
        'ten_dm': request.args.get('ten_dm') or '',
        'min_rating': request.args.get('min_rating') or '',
        'min_sales': request.args.get('min_sales') or '',
        'sort_by': column_name,
        'order': new_order
    } %}

    <a href="{{ url_for('customer_dashboard', **query_params) }}" 
       style="color: black; text-decoration: none;">
        {{ display_name }} 
        {% if current_sort == column_name %}
            {% if current_order == 'asc' %} ‚ñ≤ {% else %} ‚ñº {% endif %}
        {% else %}
            ‚áµ
        {% endif %}
    </a>
{% endmacro %}